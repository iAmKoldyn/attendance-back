# Отчёт о внедрении мониторинга и логирования в системе учёта посещаемости

## Введение

Данный отчет описывает практики мониторинга и логирования, внедренные в проекте системы учета посещаемости. Система разработана с использованием современного стека технологий и развернута с применением контейнеризации и оркестрации для обеспечения высокой доступности, масштабируемости и простоты обслуживания.

## Архитектура системы

Система состоит из следующих компонентов:

1. **Backend-сервис (attendance-server)**:
   - Node.js/Fastify-приложение на TypeScript
   - Реализует REST API для управления посещаемостью
   - Экспортирует метрики Prometheus через эндпоинт `/metrics`

2. **База данных**:
   - MongoDB для хранения данных
   - Redis для кэширования и улучшения производительности

3. **Система мониторинга**:
   - Prometheus для сбора и хранения метрик
   - Node Exporter для системных метрик
   - Grafana для визуализации метрик

4. **Инфраструктура**:
   - Docker для контейнеризации
   - Kubernetes для оркестрации
   - ConfigMaps для конфигурации

## Внедрённые практики мониторинга

### 1. Метрики приложения

В системе внедрены следующие метрики уровня приложения:

- **Метрики запросов**:
  - Счетчики запросов для всех эндпоинтов (`*RequestCounter`)
  - Счетчики ошибок для всех эндпоинтов (`*RequestErrors`)
  - Гистограммы длительности запросов (`*RequestDuration`)

- **Метрики базы данных**:
  - Метрики длительности операций с MongoDB (`dbOperationDuration*`)
  - Метрики длительности операций с Redis (`redisOperationDuration*`)

### 2. Система сбора и хранения метрик

Prometheus настроен для сбора метрик с трех источников:
- Собственные метрики Prometheus (localhost:9090)
- Метрики Node Exporter (node-exporter:9100)
- Метрики сервера посещаемости (attendance-server:3002)

Интервал сбора метрик настроен на 5 секунд для оперативного реагирования на проблемы.

### 3. Визуализация метрик

Grafana используется для визуализации метрик. Настроены дашборды для отслеживания:
- Активности сервера посещаемости
- Производительности базы данных
- Состояния системы
- Показателей использования ресурсов

## Внедрённые практики логирования

Система логирования построена на базе встроенного логгера Fastify:

1. **Уровни логирования**:
   - Настройки логов зависят от окружения (`process.env.SIRIUS_X_ATTENDANCE_PROJECT_STATUS`)
   - В продакшен-среде - выборочное логирование для снижения объема логов
   - В тестовой и разработческой среде - детальное логирование

2. **Обработка ошибок**:
   - Настроен глобальный обработчик ошибок (`setErrorHandler`)
   - Логирование ошибок валидации и иных исключений
   - Корректные HTTP-ответы с информативными сообщениями

3. **Логирование жизненного цикла**:
   - Логирование запуска и остановки сервера
   - Логирование процесса инициализации базы данных (seeding)
   - Корректное завершение работы при получении сигналов SIGINT и SIGTERM

## Развертывание в Kubernetes

Система развернута в Kubernetes-кластере с использованием следующих ресурсов:

1. **Deployments**:
   - `attendance-server-deployment.yaml` - Backend-сервис
   - `attendance-db-deployment.yaml` - MongoDB
   - `redis-deployment.yaml` - Redis
   - `prometheus-deployment.yaml` - Prometheus
   - `node-exporter-deployment.yaml` - Node Exporter
   - `grafana-deployment.yaml` - Grafana

2. **Services**:
   - `attendance-server-service.yaml`
   - `attendance-db-service.yaml`
   - `redis-service.yaml`
   - `prometheus-service.yaml`
   - `node-exporter-service.yaml`
   - `grafana-service.yaml`

3. **ConfigMaps**:
   - `attendance-env-configmap.yaml` - Переменные окружения для attendance-server
   - `prometheus-config.yaml` - Конфигурация Prometheus

## Результаты внедрения

Внедрение системы мониторинга и логирования позволило:

1. **Повысить наблюдаемость системы**:
   - Своевременное обнаружение проблем
   - Детальный анализ производительности
   - Выявление узких мест

2. **Улучшить надежность**:
   - Мониторинг состояния компонентов
   - Автоматические перезапуски при сбоях
   - Контроль ресурсов

3. **Облегчить отладку**:
   - Информативные логи
   - Метрики производительности
   - Визуализация данных

## Обоснование выбора инструментов

1. **Prometheus + Grafana**:
   - Стандарт индустрии для мониторинга
   - Высокая масштабируемость и надежность
   - Богатые возможности интеграции
   - Выразительный язык запросов (PromQL)

2. **Node Exporter**:
   - Стандартное решение для сбора системных метрик
   - Широкий набор метрик хоста
   - Легкая интеграция с Prometheus

3. **Kubernetes**:
   - Автоматическое управление контейнерами
   - Самовосстановление при сбоях
   - Централизованное управление конфигурацией
   - Масштабируемость

## Заключение

Внедренные практики мониторинга и логирования обеспечивают полную наблюдаемость системы, позволяя оперативно реагировать на проблемы и оптимизировать производительность. Использование контейнеризации и оркестрации с помощью Kubernetes обеспечивает надежность и масштабируемость системы.

## Приложения

1. Скриншоты дашбордов Grafana
2. Скриншоты метрик Prometheus
3. Примеры запросов и ответов API
4. Архитектурная схема системы 